# OAuth

## 1. OAuthë€?

ì¸í„°ë„· ì‚¬ìš©ìë“¤ì´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì œê³µí•˜ì§€ ì•Šê³  ë‹¤ë¥¸ ì›¹ì‚¬ì´íŠ¸ ìƒì˜ ìì‹ ë“¤ì˜ ì •ë³´ì— ëŒ€í•´ ì›¹ì‚¬ì´íŠ¸ë‚˜ ì–´í”Œë¦¬ì¼€ì´ì…˜ì˜ ì ‘ê·¼ ê¶Œí•œì„ ë¶€ì—¬í•  ìˆ˜ ìˆëŠ” ê³µí†µì ì¸ ìˆ˜ë‹¨ìœ¼ë¡œì„œ ì‚¬ìš©ë˜ëŠ”, ì ‘ê·¼ ìœ„ì„ì„ ìœ„í•œ ê°œë°©í˜• í‘œì¤€ì´ë‹¤.

## 2. OAuth ì°¸ì—¬ì

OAuth ë™ì‘ì— ê´€ì—¬í•˜ëŠ” ì°¸ì—¬ìëŠ” í¬ê²Œ ì„¸ ê°€ì§€ë¡œ êµ¬ë¶„í•  ìˆ˜ ìˆë‹¤.

- Resource Server: Clientê°€ ì œì–´í•˜ê³ ì í•˜ëŠ” ìì›ì„ ë³´ìœ í•˜ê³  ìˆëŠ” ì„œë²„
    - Facebook, Google, Twitter ë“±ì´ ì´ì— ì†í•œë‹¤.
- Resource Owner: ìì›ì˜ ì†Œìœ ìì´ë‹¤
    - Clientê°€ ì œê³µí•˜ëŠ” ì„œë¹„ìŠ¤ë¥¼ í†µí•´ ë¡œê·¸ì¸í•˜ëŠ” ì‹¤ì œ ìœ ì €ê°€ ì´ì— ì†í•œë‹¤.
- Client: Resource Serverì— ì ‘ì†í•´ì„œ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ê³ ì í•˜ëŠ” í´ë¼ì´ì–¸íŠ¸(ì›¹ ì–´í”Œë¦¬ì¼€ì´ì…˜)ì´ë‹¤.

## 3. OAuth Flow

ê°„ë‹¨í•œ ì›¹ ì–´í”Œë¦¬ì¼€ì´ì…˜ ì œì‘ì„ í†µí•´ OAuthì˜ ë™ì‘ í”„ë¡œì„¸ìŠ¤ë¥¼ ì´í•´í•´ë´…ì‹œë‹¤. Github ê³„ì •ì„ ë°”íƒ•ìœ¼ë¡œ ì›¹ ì–´í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ë¡œê·¸ì¸í•˜ê³ , Githubì—ì„œ ì œê³µí•˜ëŠ” ì—¬ëŸ¬ API ê¸°ëŠ¥ì„ ì™¸ë¶€ ì›¹ ì–´í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì‚¬ìš©í•´ë³´ê² ìŠµë‹ˆë‹¤.

### 3-1. Client ë“±ë¡

Client(ì›¹ ì–´í”Œë¦¬ì¼€ì´ì…˜)ê°€ Resource Serverë¥¼ ì´ìš©í•˜ê¸° ìœ„í•´ì„œëŠ” ìì‹ ì˜ ì„œë¹„ìŠ¤ë¥¼ ë“±ë¡í•¨ìœ¼ë¡œì¨ ì‚¬ì „ ìŠ¹ì¸ì„ ë°›ì•„ì•¼ í•œë‹¤. Github Developer Settingì—ì„œ Githubì— ì›¹ ì–´í”Œë¦¬ì¼€ì´ì…˜ì„ ë“±ë¡í•œë‹¤.

![Untitled](Tech-Seminar/Contents/res/seminar-17/Untitled.png)

![Untitled](Tech-Seminar/Contents/res/seminar-17/Untitled%201.png)

ë“±ë¡ ì ˆì°¨ë¥¼ í†µí•´ ì„¸ ê°€ì§€ ì •ë³´ë¥¼ ë¶€ì—¬ë°›ìŠµë‹ˆë‹¤.

1. Client ID: í´ë¼ì´ì–¸íŠ¸ ì›¹ ì–´í”Œë¦¬ì¼€ì´ì…˜ì„ êµ¬ë³„í•  ìˆ˜ ìˆëŠ” ì‹ë³„ìì´ë©°, ë…¸ì¶œí•´ë„ ë¬´ë°©í•©ë‹ˆë‹¤.
2. Client Secret: Client IDì— ëŒ€í•œ ë¹„ë°€í‚¤ë¡œì„œ, ì ˆëŒ€ ë…¸ì¶œí•´ì„œëŠ” ì•ˆë©ë‹ˆë‹¤.
3. Authorized redirect URL: Authorization Codeë¥¼ ì „ë‹¬ë°›ì„ ë¦¬ë‹¤ì´ë ‰íŠ¸ ì£¼ì†Œì…ë‹ˆë‹¤.

Google ë“± ì™¸ë¶€ ì„œë¹„ìŠ¤ë¥¼ í†µí•´ ì¸ì¦ì„ ë§ˆì¹˜ë©´ í´ë¼ì´ì–¸íŠ¸ë¥¼ ëª…ì‹œëœ ì£¼ì†Œë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ ì‹œí‚¤ëŠ”ë°, ì´ ë•Œ Query Stringìœ¼ë¡œ íŠ¹ë³„í•œ Codeê°€ í•¨ê»˜ ì „ë‹¬ë©ë‹ˆë‹¤.

í´ë¼ì´ì–¸íŠ¸ëŠ” í•´ë‹¹ Codeì™€ Client ID ë° Client Secretì„ Resource Serverì— ë³´ë‚´, Resource Serverì˜ ìì›ì„ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” Access Tokenì„ ë°œê¸‰ë°›ìŠµë‹ˆë‹¤. ë“±ë¡ë˜ì§€ ì•Šì€ ë¦¬ë‹¤ì´ë ‰íŠ¸ URLì„ ì‚¬ìš©í•˜ëŠ” ê²½ìš°, Resource Serverê°€ ì¸ì¦ì„ ê±°ë¶€í•©ë‹ˆë‹¤.

### 3-2. Resource Ownerì˜ ìŠ¹ì¸

Github Docsì—ì„œëŠ” Github ì†Œì…œ ë¡œê·¸ì¸ì„ í•˜ê¸° ìœ„í•´ ë‹¤ìŒê³¼ ê°™ì€ ì£¼ì†Œë¡œ GET ìš”ì²­ê³¼ í•„ìš”í•œ íŒŒë¼ë¯¸í„°ë“¤ì„ ë³´ë‚´ë„ë¡ ëª…ì‹œí•©ë‹ˆë‹¤.

```java
GET https://github.com/login/oauth/authorize?
client_id={client_id}&redirect_uri={redirect_uri}?scope={scope}
```

- scopeëŠ” Clientê°€ Resource Serverë¡œë¶€í„° ì¸ê°€ë°›ì„ ê¶Œí•œì˜ ë²”ìœ„ì…ë‹ˆë‹¤.
- íŒŒë¼ë¯¸í„°ì˜ ì„¸ë¶€ ì˜µì…˜ì— ëŒ€í•œ ë‚´ìš©ì€ ë¬¸ì„œë¥¼ ì°¸ê³ í•˜ì‹œê¸¸ ë°”ëë‹ˆë‹¤.

Resource OwnerëŠ” Clientì˜ ì›¹ ì–´í”Œë¦¬ì¼€ì´ì…˜ì„ ì´ìš©í•˜ë‹¤ê°€, í•´ë‹¹ ì£¼ì†Œë¡œ ì—°ê²°ë˜ëŠ” ì†Œì…œ ë¡œê·¸ì¸ ë²„íŠ¼ì„ í´ë¦­í•©ë‹ˆë‹¤.

![Untitled](Tech-Seminar/Contents/res/seminar-17/Untitled%202.png)

Resource OwnerëŠ” Resource Serverì— ì ‘ì†í•˜ì—¬ ë¡œê·¸ì¸ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ì´ ì™„ë£Œë˜ë©´ Resource ServerëŠ” Query Stringìœ¼ë¡œ ë„˜ì–´ì˜¨ íŒŒë¼ë¯¸í„°ë“¤ì„ í†µí•´ Clientë¥¼ ê²€ì‚¬í•©ë‹ˆë‹¤.

- íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬ëœ Client IDì™€ ë™ì¼í•œ IDê°’ì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
- í•´ë‹¹ Client IDì— í•´ë‹¹í•˜ëŠ” Redirect URLì´ íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬ëœ Redirect URLê³¼ ê°™ì€ì§€ í™•ì¸í•©ë‹ˆë‹¤.

![Untitled](Tech-Seminar/Contents/res/seminar-17/Untitled%203.png)

ê²€ì¦ì´ ë§ˆë¬´ë¦¬ë˜ë©´ Resource ServerëŠ” Resource Ownerì—ê²Œ ë‹¤ìŒê³¼ ê°™ì€ ì§ˆì˜ë¥¼ ë³´ëƒ…ë‹ˆë‹¤.

- ëª…ì‹œí•œ scopeì— í•´ë‹¹í•˜ëŠ” ê¶Œí•œì„ Clientì—ê²Œ ì •ë§ë¡œ ë¶€ì—¬í•  ê²ƒì¸ê°€?

í—ˆìš©í•œë‹¤ë©´ ìµœì¢…ì ìœ¼ë¡œ Resource Ownerê°€ Resource Serverì—ê²Œ Clientì˜ ì ‘ê·¼ì„ ìŠ¹ì¸í•˜ê²Œ ë©ë‹ˆë‹¤.

### 3-3. Resource Serverì˜ ìŠ¹ì¸

Resource Ownerì˜ ìŠ¹ì¸ì´ ë§ˆë¬´ë¦¬ë˜ë©´ ëª…ì‹œëœ Redirect URLë¡œ í´ë¼ì´ì–¸íŠ¸ë¥¼ ë¦¬ë‹¤ì´ë ‰íŠ¸ì‹œí‚µë‹ˆë‹¤. ì´ ë•Œ Resource ServerëŠ” Clientê°€ ìì‹ ì˜ ìì›ì„ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” Access Tokenì„ ë°œê¸‰í•˜ê¸° ì „ì—, ì„ì‹œ ì•”í˜¸ì¸ Authorization Codeë¥¼ í•¨ê»˜ ë°œê¸‰í•©ë‹ˆë‹¤.

![Untitled](Tech-Seminar/Contents/res/seminar-17/Untitled%204.png)

- Query Stringìœ¼ë¡œ ë“¤ì–´ì˜¨ codeê°€ ë°”ë¡œ Authorization Codeì…ë‹ˆë‹¤.

> OAuthController.java
> 

```java
@GetMapping("/afterlogin")
public ResponseEntity<String> afterLogin(@RequestParam String code) {
	if(Objects.isNull(code)) {
		throw new IllegalStateException("Github ë¡œê·¸ì¸ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
	}

	RestTemplate restTemplate = new RestTemplate();
	OAuthDto oauthDto = new OAuthDto();
	oauthDto.setCode(code);
	oauthDto.setClient_ID("7e930566ecaa306c71b5");
	oauthDto.setClient_secret("client secret ì…ë ¥");
	String accessToken = restTemplate.postForObject(
		"https://github.com/login/oauth/access_token", oauthDto, String.class
	);
	return ResponseEntity.ok(accessToken);
}
```

ClientëŠ” IDì™€ ë¹„ë°€í‚¤ ë° codeë¥¼ Resource Ownerë¥¼ ê±°ì¹˜ì§€ ì•Šê³  Resource Serverì— ì§ì ‘ ì „ë‹¬í•©ë‹ˆë‹¤. Resource ServerëŠ” ì •ë³´ë¥¼ ê²€ì‚¬í•œ ë‹¤ìŒ, ìœ íš¨í•œ ìš”ì²­ì´ë¼ë©´ Access Tokenì„ ë°œê¸‰í•˜ê²Œ ë©ë‹ˆë‹¤.

![Untitled](Tech-Seminar/Contents/res/seminar-17/Untitled%205.png)

ClientëŠ” í•´ë‹¹ í† í°ì„ ì„œë²„ì— ì €ì¥í•´ë‘ê³ , Resource Serverì˜ ìì›ì„ ì‚¬ìš©í•˜ê¸° ìœ„í•œ API í˜¸ì¶œ ì‹œ í•´ë‹¹ í† í°ì„ í—¤ë”ì— ë‹´ì•„ ë³´ëƒ…ë‹ˆë‹¤.

### 3-4. API í˜¸ì¶œ

![Untitled](Tech-Seminar/Contents/res/seminar-17/Untitled%206.png)

ì´í›„ Access Tokenì„ í—¤ë”ì— ë‹´ì•„ Github APIë¥¼ í˜¸ì¶œí•˜ë©´, í•´ë‹¹ ê³„ì •ê³¼ ì—°ë™ëœ Resource Serverì˜ í’ë¶€í•œ ìì› ë° ê¸°ëŠ¥ë“¤ì„ ë‚´ê°€ ë§Œë“  ì›¹ ì–´í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### 3-5. Refresh Token

Refresh Tokenì˜ ë°œê¸‰ ì—¬ë¶€ì™€ ë°©ë²• ë° ê°±ì‹  ì£¼ê¸° ë“±ì€ OAuthë¥¼ ì œê³µí•˜ëŠ” Resource Serverë§ˆë‹¤ ìƒì´í•©ë‹ˆë‹¤.

Access Tokenì€ ë§Œë£Œ ê¸°ê°„ì´ ìˆìœ¼ë©°, ë§Œë£Œëœ Access Tokenìœ¼ë¡œ APIë¥¼ ìš”ì²­í•˜ë©´ 401 ì—ëŸ¬ê°€ ë°œìƒí•©ë‹ˆë‹¤. Access Tokenì´ ë§Œë£Œë˜ì–´ ì¬ë°œê¸‰ë°›ì„ ë•Œë§ˆë‹¤ ì„œë¹„ìŠ¤ ì´ìš©ìê°€ ì¬ ë¡œê·¸ì¸í•˜ëŠ” ê²ƒì€ ë²ˆê±°ë¡­ìŠµë‹ˆë‹¤.

ë³´í†µ Resource ServerëŠ” Access Tokenì„ ë°œê¸‰í•  ë•Œ Refresh Tokenì„ í•¨ê»˜ ë°œê¸‰í•©ë‹ˆë‹¤. ClientëŠ” ë‘ Tokenì„ ëª¨ë‘ ì €ì¥í•´ë‘ê³ , Access Tokenì´ ë§Œë£Œë˜ì–´ 401 ì—ëŸ¬ê°€ ë°œìƒí•˜ë©´, ClientëŠ” ë³´ê´€ ì¤‘ì´ë˜ Refresh Tokenì„ ë³´ë‚´ ìƒˆë¡œìš´ Access Tokenì„ ë°œê¸‰ë°›ê²Œ ë©ë‹ˆë‹¤.

## ì¶œì²˜

[https://tecoble.techcourse.co.kr/post/2021-07-10-understanding-oauth/](https://tecoble.techcourse.co.kr/post/2021-07-10-understanding-oauth/)

---

[https://inpa.tistory.com/entry/WEB-ğŸ“š-OAuth-20-ê°œë…-ğŸ’¯-ì •ë¦¬](https://inpa.tistory.com/entry/WEB-%F0%9F%93%9A-OAuth-20-%EA%B0%9C%EB%85%90-%F0%9F%92%AF-%EC%A0%95%EB%A6%AC)

[https://showerbugs.github.io/2017-11-16/OAuth-ë€-ë¬´ì—‡ì¼ê¹Œ](https://showerbugs.github.io/2017-11-16/OAuth-%EB%9E%80-%EB%AC%B4%EC%97%87%EC%9D%BC%EA%B9%8C)

[https://velog.io/@max9106/OAuth](https://velog.io/@max9106/OAuth)

ì˜ˆì‹œ í”„ë¡œì íŠ¸

[https://deeplify.dev/back-end/spring/oauth2-social-login](https://deeplify.dev/back-end/spring/oauth2-social-login)

[https://velog.io/@swchoi0329/ìŠ¤í”„ë§-ì‹œíë¦¬í‹°ì™€-OAuth-2.0ìœ¼ë¡œ-ë¡œê·¸ì¸-ê¸°ëŠ¥-êµ¬í˜„](https://velog.io/@swchoi0329/%EC%8A%A4%ED%94%84%EB%A7%81-%EC%8B%9C%ED%81%90%EB%A6%AC%ED%8B%B0%EC%99%80-OAuth-2.0%EC%9C%BC%EB%A1%9C-%EB%A1%9C%EA%B7%B8%EC%9D%B8-%EA%B8%B0%EB%8A%A5-%EA%B5%AC%ED%98%84)
