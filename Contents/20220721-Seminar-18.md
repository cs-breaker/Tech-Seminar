# 교착상태(Deadlock) / 뮤텍스(Mutex)와 세마포어(Semaphore)

---

## 교착상태(Deadlock)란?
- 두 개 이상의 작업이 서로 상대방의 작업이 끝나기 만을 기다리고 있기 때문에 결과적으로 아무것도 완료되지 못하는 상태
- 즉, 둘 이상의 프로세스 혹은 스레드가 한정된 자원을 얻지 못해 다음 처리를 진행하지 못하는 상태이다.
- 가장 자주 볼 수 있는 예시로는, 데이터베이스에 트랜잭션 데드락이 있다.

## 교착상태 발생 조건
- 교착상태 발생 조건으로는 4가지가 존재하는데, 4가지 모두 만족했을 때 교착상태가 발생한다.
1. 상호 배제 조건 (Mutual exclusion condition)
	- 프로세스는 한 번에 하나의 자원만 사용할 수 있다.
	- 사용중인 자원을 다른 프로세스가 사용하기 위해서는 자원이 해제될 때까지 기다려야 한다.
2. 점유와 대기 조건 (hole-and-wait condition)
	- 자원을 최소한 하나 보유하고 다른 프로세스에 할당되어 사용중인 자원을 점유하기 위해 기다려야 한다.
3. 비선점 조건 (nopreemption condition)
	- 이미 할당되어 사용중인 자원을 다른 프로세스가 선점할 수 없다.
4. 순환 대기 조건 (circular-wait condition)
	- 대기 프로세스의 집합이 순환 형태로 자원을 사용하기 위해 대기하고 있어야 한다.

## 교착상태 해결 방법
1. Deadlock의 상태를 미리 '예방'한다.
	- 교착상태가 발생되지 않도록 사전에 예방하는 방법
	- 교착상태 발생 조건 4가지 중 하나를 제거함으로써 해결하는 방법
		1. 자원의 상호 배제 조건
			- 한 번에 여러 프로세스가 공유 자원을 사용할 수 있게 한다.
		2. 점유 대기 조건 방지
			- 프로세스 실행에 필요한 모든 자원을 한꺼번에 요구하고 허용할 때까지 작업을 보류해서, 나중에 또 다른 자원을 점유하기 위한 대기 조건을 성립하지 않도록 한다.
		3. 비선점 조건 방지
			- 다른 프로세스에게 할당된 자원이 선점권이 없다고 가정할 때, 높은 우선순위의 프로세스가 해당 자원을 선점할 수 있도록 한다.
		4. 순환 대기 조건 방지
			- 자원을 순환 형태로 대기하지 않도록 일정한 한 쪽 방향으로만 자원을 요구할 수 있도록 한다.
	- 하지만 이와 같이 미리 Deadlock을 예방하게 되면, 시스템의 처리량이나 효율성을 떨어트리는 문제점이 발생할 수 있다.
2. Deadlock의 상태를 인정하고 '회피'한다.
	- 교착 상태 발생 가능성을 검사해서 발생 가능성이 있다면 사전에 회피하는 방식이다.
	- 자원 할당 그래프 알고리즘과 은행원 알고리즘을 사용할 수 있다.
	- Deadlock 회피 방법의 flow
		1. 프로세스가 자원 요청시, 자원을 할당한 후에도 안정 상태로 남아있는지 사전 검사한다.
		2. 안정 상태라면 자원을 할당한다.
		3. 불안정 상태라면 다른 프로세스가 자원을 해지할 때까지 대기한다.
	- 자원을 요청할 때마다 시스템 상태를 검사하는 만큼 오버헤드가 크다.
	- 은행원 알고리즘의 경우 전제 조건이 많다.
3. Deadlock을 '탐지'하고 '회복'한다.
	- 교착상태를 허용하지만 상태를 탐지하고 회복하는 방식이다.
	- 탐지 기법이란,
		- Allocation, Request, Available 등으로 시스템에 Deadlock이 발생했는지 여부를 탐색한다.
		- 이 외에도 자원 할당 그래프를 통해 탐지하는 방법이 있다.
	- 회복 기법이란,
		- 교착 상태에 빠진 모든 프로세스를 중단시키거나, 프로세스를 하나씩 중단 시킬 때마다 탐지 알고리즘으로 Deadlock을 탐지하면서 회복시키는 방법이 있다.
		- 또는 프로세스에 할당된 자원을 선점해서, 교착 상태를 해결할 때까지 그 자원을 다른 프로세스에 할당해 주는 방법이 있다.
4. Deadlock을 '무시'한다.
	- 교착상태를 일으킨 프로세스를 종료하거나, 할당된 자원을 해제함으로써 회복한다.
	- 방법 1. 프로세스 종료
		- 교착 상태의 프로세스를 모두 중지한다.
		- 교착 상태가 제거될 때까지 한 프로세스씩 중지한다.
	- 방법 2. 자원 선점
		- 교착상태가 제거될 때까지 프로세스가 점유한 자원을 선점해 다른 프로세스에게 할당한다.




---


## 뮤텍스(Mutex)와 세마포어(Semaphore)
교착상태(Deadlock)의 발생 조건 중 '상호 배제 조건'을 해결하기 위한 방법으로 뮤텍스와 세마포어가 있다.

### 뮤텍스?
뮤텍스는 mutual과 exclusion의 합성어로, 여러 스레드를 실행하는 환경에서 자원에 대한 접근에 제한을 강제하기 위한 동기화 메커니즘을 말한다.

1. Boolean 타입의 Lock 변수를 사용하여 자원에 대한 접근을 제한한다.
2. 임계영역 (Critical section)의 자원에 접근하면 해당 스레드는 Lock을 걸어버린다. 이 때, 다른 스레드가 공유자원에 접근하면 Blocking 후 대기 큐로 보낸다.
3. 공유자원 사용을 마친 스레드는 Lock을 해제한다. Lock 해제는 Lock을 건 스레드만 해제할 수 있다.

### 세마포어?
세마포어는 변수를 통해 접근 가능한 스레드를 제한한다.
뮤텍스는 1개의 스레드만 자원을 사용할 수 있었으나, 세마포어는 세마포어의 변수만큼 공유 자원에 접근할 수 있다.

1. 세마포어 변수를 통해 wait, signal을 관리한다. 세마포어 변수는 0이상의 정수 값을 갖는다.
2. 세마포어 변수가 1개인 경우, 뮤텍스처럼 사용이 가능하다.
3. 뮤텍스와 달리 Lock을 걸지 않은 스레드도 signal을 보내 Lock을 해제할 수 있다.



