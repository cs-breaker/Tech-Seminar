# 스프링 빈

작성자 : 박성민

작성일 : 2022-08-29

---

## Bean이란?

스프링은 자바 객체를 쉽게 관리할 수 있도록 Spring IoC 컨테이너에 등록해서 사용한다. 이 때 등록된 자바 객체를 bean이라고 한다.

## Bean Scope

스프링은 빈이라는 개념으로 자바 객체를 만들고 싱글톤화 시켜 관리해준다.

이 객체들은 스프링 IoC 컨테이너에 의해 생성되고 소멸되는 등의 관리가 이루어 진다. 이때 **bean이 관리되는 범위를 scope라고 한다.** bean이 싱글턴화 돼서 관리되는 이유는 spring bean의 기본 scope 전략이 싱글턴이기 때문이다.

## Bean Scope 종류

### singleton

- 디폴트
- 어플리케이션에 오직 하나만 생성되는 일반적인 스코프이다.
- @Component, @Configuration + @Bean의 조합으로 등록된 bean들의 기본 스코프이다.

### prototype

- 컨테이너에게 빈을 요청할 때마다 매번 새로운 객체를 생성해준다.
- 프로토타입을 받은 클라이언트가 객체를 관리하여 준다.
- 정상적인 방식으로 gc에 의해 빈이 제거된다.

### web scope

- 웹환경에서만 동작하는 스코프이다.
- 4가지 종류가 있다.

1. **request**
   - request가 생성되면 bean이 생성되고 종료된다.
   - @Scope(value = “request”) , @RequestScope
2. **session**
   - 세션과 동일한 생명 주기를 가진다.
3. **application**
   - 웹의 서블릿 컨텍스트와 동일한 생명주기를 가진다.
4. **websocket**
   - 웹소켓과 동일한 생명주기를 가진다.

### 싱글턴으로 적합한 객체

- 상태가 없는 공유 객체 : 상태가 없기에 동기화 비용이 없음.
- 읽기용으로만 상태를 가진 공유 객체 : 읽기 전용이므로 동기화 비용이 들지 않는다.
- 공유가 필요한 상태를 지닌 공유 객체
- 쓰기가 가능한 상태를 지니면서도 사용빈도가 매우 높은 객체

### 비싱글턴으로 적합한 객체

- 쓰기가 가능한 상태를 지닌 객체 : 쓰기가 가능한 상태가 많아서 동기화 비용이 객체 생성비용보다 크다면 싱글턴으로 적합하지 않다.
- 상태가 노출되지 않은 객체

## 싱글톤 패턴에서의 주의점

- 하나의 인스턴스를 생성해서 공유하는 형식이므로 객체의 상태를 유지하게(stateful) 설계하면 안된다.
- 특정 클라이언트에 의존적이거나 값을 변경할 수 있는 필드가 있으면 안된다.
- 가급적 읽기만 가능해야 한다.
- 필드 대신 공유되지 않는 지역변수,파라미터,ThreadLocal을 쓰자.(예를 들어 필드를 반환하는게 아닌 파라미터를 반환하자)

## 빈 생명주기 콜백

- 애플리케이션 시작 시점에 필요한 연결을 미리 해두고, 애플리케이션 종료 시점에 연결을 모두 종료하는 작업을 진행하려면, 객체의 초기화와 종료 작업이 필요하다.
- 스프링 빈은 `객체 생성 → 의존관계 주입` 과 같은 라이프사이클을 가진다.
- 스프링 빈은 객체를 생성하고, 의존관계 주입이 다 끝난 다음에야 필요한 데이터를 사용할 수 있는 준비가 완료된다. 따라서 초기화 작업은 의존관계 주입이 모두 완료되고 난 다음에 호출해야 한다.
- 스프링은 의존관계 주입이 완료되면 스프링 빈에게 콜백 메소드를 통해서 초기화 시점을 알려주는 다양한 기능을 제공한다. 또한 스프링은 스프링 컨테이너가 종료되기 직전에 소멸 콜백을 준다.
- 스프링 빈의 이벤트 라이프사이클
  - 스프링 컨테이너 생성 → 스프링 빈 생성 → 의존관계 주입 → 초기화 콜백 → 사용 → 소멸전 콜백 → 스프링 종료
- 초기화 콜백 : 빈이 생성되고, 빈의 의존관계 주입이 완료된 후 호출
- 소멸전 콜백 : 빈이 소멸되기 직전에 호출
- 스프링은 크게 3가지 방법으로 빈 생명주기 콜백을 지원한다.

### 인터페이스 InitializingBean, DisposableBean

- `InitializingBean`의 `afterPropertiesSet()` 메서드로 초기화 지원
- `DisposableBean`의 `destroy()` 메서드로 소멸 지원
- 스프링 전용 인터페이스이기 때문에, 스프링 전용 인터페이스에 의존하게 된다.
- 내가 코드를 수정할 수 없는 외부 라이브러리에 적용 불가능
- 지금은 거의 사용하지 않는다.

### 빈 등록 초기화, 소멸 메서드 지정

- 설정 정보에 `@Bean(initMethod = "init", destroyMethod = "close")` 처럼 초기화, 소멸 메서드를 지정할 수 있다.
- 스프링 빈이 스프링 코드에 의존하지 않는다.
- 메서드 이름을 자유롭게 줄 수 있다.
- 코드가 아니라 설정 정보를 사용하기 외부 라이브러리에도 초기화, 종료 메서드를 적용할 수 있다.
- @Bean의 destroyMethod에는 close, shutdown라는 이름의 메서드를 자동으로 호출해준다. 기본값이 (inferred) (추론)으로 등록되어 있어 이름 그대로 종료 메서드를 추론해서 호출해준다.
  그래서 직접 스프링 빈으로 등록하면 종료 메서드는 따로 적어주지 않아도 잘 동작한다.
  라이브러리는 대부분 close, shutdown 이라는 이름의 종료 메서드를 사용한다.

### 애노테이션 @PostConstruct, @PreDestroy

- 지금은 이걸 쓴다.
- 가장 편리하게 초기화와 종료를 실행할 수 있다.
- 패키지가 자바 표준이라 스프링이 아닌 다른 컨테이너에서도 동작한다.
- 컴포넌트 스캔과 잘 어울린다.
- 하지만 외부 라이브러리에는 적용하지 못한다. 외부 라이브러리에서는 @Bean 기능을 사용하자(2번째)
